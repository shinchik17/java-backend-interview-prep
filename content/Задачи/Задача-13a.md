#### 13. –ó–∞–¥–∞—á–∞. SQL. –ö–∞–∫ –Ω–∞–ø–∏—Å–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å, —á—Ç–æ–±—ã –≤—ã–≤–µ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —É –∫–æ—Ç–æ—Ä—ã—Ö –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è?

```sql
CREATE TABLE USER (
    id INT,
    name VARCHAR(50)
);

INSERT INTO USER (id, name) VALUES
(1, 'Ivan'),
(2, 'Oleg'),
(3, 'Anna'),
(4, 'Ivan'),
(5, 'Ted');

CREATE TABLE CAR (
    id INT,
    model VARCHAR(50)
);

INSERT INTO CAR (id, model) VALUES
(4422, 'Opel 1'),
(4523, 'BMV 5'),
(4612, 'VW'),
(4853, 'BMV 6');

```

{{< hint warning >}}
**–°–ø–æ–π–ª–µ—Ä—ã –∫ —Ä–µ—à–µ–Ω–∏—é** ¬†
{{< /hint >}}

{{< details "–ü–æ–¥—Å–∫–∞–∑–∫–∏" close >}}
- –ù–∞–º –Ω—É–∂–Ω–æ **–ø–æ—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—à–∏–Ω** —É –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- –ò—Å–ø–æ–ª—å–∑—É–µ–º `GROUP BY user_id` –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.
- –ü—Ä–∏–º–µ–Ω—è–µ–º `HAVING COUNT(*) > 1`, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ—Ö, —É –∫–æ–≥–æ **–±–æ–ª—å—à–µ –æ–¥–Ω–æ–π –º–∞—à–∏–Ω—ã**.
- –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ `CAR` —Å–≤—è–∑–∞–Ω–∞ —Å `USER`, –¥–æ–±–∞–≤–∏–≤ `user_id` –≤ `CAR`.
{{< /details >}}

{{< details "–†–µ—à–µ–Ω–∏–µ" close >}}

–î–æ–±–∞–≤–ª—è–µ–º –≤–Ω–µ—à–Ω–∏–π –∫–ª—é—á, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç:

```sql
ALTER TABLE CAR ADD COLUMN user_id INT;
ALTER TABLE CAR ADD FOREIGN KEY (user_id) REFERENCES USER(id);
```

–ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –±–æ–ª–µ–µ —á–µ–º –æ–¥–Ω–æ–π –º–∞—à–∏–Ω–æ–π:

```sql
SELECT u.id, u.name, COUNT(c.id) AS car_count
FROM USER u
JOIN CAR c ON u.id = c.user_id
GROUP BY u.id, u.name
HAVING COUNT(c.id) > 1;
```

üîπ **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?**

- `JOIN` –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ç–∞–±–ª–∏—Ü—ã `USER` –∏ `CAR` –ø–æ `user_id`.
- `GROUP BY u.id, u.name` –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.
- `COUNT(c.id)` —Å—á–∏—Ç–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—à–∏–Ω —É –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- `HAVING COUNT(c.id) > 1` –æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å **–¥–≤—É–º—è –∏ –±–æ–ª–µ–µ –º–∞—à–∏–Ω–∞–º–∏**.

**–í—ã—Ö–æ–¥:**

```
id | name  | car_count
----------------------
1  | Ivan  | 2
```

–ó–Ω–∞—á–∏—Ç, **—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "Ivan" –±–æ–ª—å—à–µ –æ–¥–Ω–æ–π –º–∞—à–∏–Ω—ã**. üöóüöó
{{< /details >}}
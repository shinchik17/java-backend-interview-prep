#### 53. –ü–µ—Ä–µ–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ –º–µ–∂–¥—É –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏

–ï—Å—Ç—å Spring —Å–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–¥–∞—á–∏ –¥–µ–Ω–µ–≥ —Å –æ–¥–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –Ω–∞ –¥—Ä—É–≥–æ–π. –ï—Å—Ç—å –º–µ—Ç–æ–¥ transferAmount(), –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∞–ª–∏–∑—É–µ—Ç —ç—Ç—É –ª–æ–≥–∏–∫—É. –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç 3 –ø–∞—Ä–∞–º–µ—Ç—Ä–∞: –∞–∫–∫–∞—É–Ω—Ç —Å –∫–æ—Ç–æ—Ä–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∏–º, –∫—É–¥–∞ –ø–µ—Ä–µ–≤–æ–¥–∏–º –∏ amount —Å—É–º–º—É –ø–µ—Ä–µ–≤–æ–¥–∞. –ó–∞–¥–∞—á–∏: –≤—ã–±—Ä–∞—Ç—å —Ç–∏–ø amount, –æ–±–æ—Å–Ω–æ–≤–∞—Ç—å –≤—ã–±–æ—Ä. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ–≤–æ–¥–∞. –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏, –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ä–µ—à–µ–Ω–∏—è, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. –ë–î –Ω–µ—Ç, –≤—Å–µ —Ö—Ä–∞–Ω–∏–º –≤ –ø–∞–º—è—Ç–∏. –°–µ—Ç–µ–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ REST –Ω–µ—Ç


**–£—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞—á–∏:**  
üìå –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥ `transferAmount(Account from, Account to, ??? amount)` –≤ —Å–µ—Ä–≤–∏—Å–µ, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –¥–µ–Ω—å–≥–∏ –∏–∑ –æ–¥–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ –¥—Ä—É–≥–æ–π.
- –í—Å—ë —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ ‚Äî –±–µ–∑ –ë–î.
- –ë–µ–∑ —Å–µ—Ç–µ–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è.
- –§–æ–∫—É—Å –Ω–∞ **–≤—ã–±–æ—Ä–µ —Ç–∏–ø–∞** –¥–ª—è —Å—É–º–º—ã, **–≤–∞–ª–∏–¥–∞—Ü–∏–∏**, **–±–∏–∑–Ω–µ—Å‚Äë–ª–æ–≥–∏–∫–µ**, **–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏** –∏ **–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**.

**–ö–æ–¥:**

```java
class Account {
    // TODO –°—é–¥–∞ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –ø–æ–ª—è
}

class TransferService {
    void transferAmount(Account from, Account to, ??? amount) {
        // TODO –°—é–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥–∏–∫—É —Å–ø–∏—Å–∞–Ω–∏—è/–ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—á–µ—Ç–æ–≤
    }
}
````

{{< hint warning >}}  
**–°–ø–æ–π–ª–µ—Ä—ã –∫ —Ä–µ—à–µ–Ω–∏—é**  
{{< /hint >}}

{{< details "–ü–æ–¥—Å–∫–∞–∑–∫–∏" close >}}  
üí° **–¢–∏–ø `BigDecimal`** ‚Äî –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –¥–µ–Ω–µ–≥: —Ç–æ—á–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –±–µ–∑ –ø–æ—Ç–µ—Ä—å.  
üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `from`, `to` –∏ `amount` –Ω–µ `null`, –∏ `amount > 0`.  
üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `from` –∏ `to` ‚Äî —Ä–∞–∑–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã.  
üí° –ü–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ, —á—Ç–æ `from.getBalance().compareTo(amount) >= 0`.  
üí° –î–ª—è –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –±–ª–æ–∫–∏—Ä—É–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç—ã –≤ –ø–æ—Ä—è–¥–∫–µ `id`, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–µ–¥–ª–æ–∫–∞.  
{{< /details >}}

{{< details "–†–µ—à–µ–Ω–∏–µ" close >}}

```java
import java.math.BigDecimal;
import java.util.Objects;

public class TransferService {

    public void transferAmount(Account from, Account to, BigDecimal amount) {
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        Objects.requireNonNull(from, "Source account must not be null");
        Objects.requireNonNull(to,   "Target account must not be null");
        Objects.requireNonNull(amount, "Amount must not be null");
        if (amount.compareTo(BigDecimal.ZERO) <= 0) {
            throw new IllegalArgumentException("Amount must be positive");
        }
        if (from.getId().equals(to.getId())) {
            throw new IllegalArgumentException("Cannot transfer to the same account");
        }

        // –í—ã–±–∏—Ä–∞–µ–º –ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –ø–æ id –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –¥–µ–¥–ª–æ–∫–æ–≤
        Account first  = from.getId().compareTo(to.getId()) < 0 ? from : to;
        Account second = first == from ? to : from;

        synchronized (first) {
            synchronized (second) {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤
                if (from.getBalance().compareTo(amount) < 0) {
                    throw new IllegalArgumentException(
                        "Insufficient funds in account " + from.getId());
                }
                // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–µ–≤–æ–¥
                from.debit(amount);
                to.credit(amount);
            }
        }
    }
}
```

{{< /details >}}
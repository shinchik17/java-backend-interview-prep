#### 52. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ SomeServiceImpl –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏


–î–∞–Ω –∫–æ–¥. –ù–∞–¥–æ –Ω–∞–π—Ç–∏ –æ—à–∏–±–∫–∏ –≤ –∫–ª–∞—Å—Å–µ –∏ –ø–æ–ø—Ä–∞–≤–∏—Ç—å. –î–∞–Ω –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å. –ó–∞–ø—É—â–µ–Ω–æ –≤ k8s 8 –ø–æ–¥–æ–≤ (—Ä–µ–ø–ª–∏–∫). –¶–µ–ª—å –∫–æ–¥–∞ –≤—ã—á–∏—Ç–∞—Ç—å –∏–∑ –ë–î –∑–∞–ø–∏—Å–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Å–µ—Ä–≤–∏—Å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏. –ó–∞ —ç—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç –º–µ—Ç–æ–¥ processJobRunning(). –ò –≤—Ç–æ—Ä–∞—è –∑–∞–¥–∞—á–∞ –∫–æ–¥–∞: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ–∫–∏ –≤ –Ω–∞–ª–æ–≥–æ–≤—É—é. –°–Ω–∞—Ä—É–∂–∏ –∏–∑ –¥—Ä—É–≥–æ–≥–æ –Ω–∞—à–µ–≥–æ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∑–∞–ø—Ä–æ—Å sendReceipt(). –û–±—ä–µ–∫—Ç taxClient –Ω–∞–ø–æ–¥–æ–±–∏–µ feign client. –ù–∞–ª–æ–≥–æ–≤–∞—è –º–æ–∂–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –±–æ–ª—å—à–µ 10 —Å–µ–∫, –∞ –Ω–∞–º –Ω—É–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –±—ã—Å—Ç—Ä–æ. –ö–∞–∫ —ç—Ç–æ –ø–æ—Ä–µ—à–∞—Ç—å? –¢–∞–º, –≥–¥–µ –Ω–∞–ø–∏—Å–∞–Ω–æ "–≥—Ä–∞–Ω–∏—Ü–∞ –∫–ª–∞—Å—Å–∞", —Ç–∞–º –Ω–∏–∂–µ –µ—Å—Ç—å DTO-—à–∫–∏, —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–æ–¥. –ò —Ç–∞–º –æ—à–∏–±–∫–∏ –Ω–µ –Ω–∞–¥–æ –∏—Å–∫–∞—Ç—å




**–£—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞—á–∏:**  
üìå –î–∞–Ω—ã –¥–≤–∞ –º–µ—Ç–æ–¥–∞ –≤ –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–º Spring‚Äë–º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–µ:
1. `processJobRunning()` ‚Äî —Ä–∞–∑ –≤ —á–∞—Å —á–∏—Ç–∞–µ—Ç –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –≤–æ–∑–≤—Ä–∞—Ç–Ω—ã–µ —á–µ–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫—É, –∑–∞—Ç–µ–º —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —á–µ–∫.
2. `sendReceipt()` ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ—Ç DTO —á–µ–∫–∞ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç –≤–Ω–µ—à–Ω–∏–π Feign‚Äë–∫–ª–∏–µ–Ω—Ç `taxClient.sendReceipt()`, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –¥–æ 60 —Å–µ–∫—É–Ω–¥.  
   –ù—É–∂–Ω–æ:
- –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏ –≤ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ AOP, –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤—ã–∑–æ–≤ `findById()`, –∫–∞–≤—ã—á–∫–∏ –≤ `@Scheduled` –∏ —Ç.–ø.).
- –û–±–µ—Å–ø–µ—á–∏—Ç—å, —á—Ç–æ–±—ã –º–µ—Ç–æ–¥ `sendReceipt()` –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –ø–æ—Ç–æ–∫ –æ–∂–∏–¥–∞–Ω–∏–µ–º –æ—Ç–≤–µ—Ç–∞ –Ω–∞–ª–æ–≥–æ–≤–æ–π, –∞ —Ä–∞–±–æ—Ç–∞–ª –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ.

**–ö–æ–¥:**

```java
// –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å —á–µ–∫–æ–≤ –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞, –¥–µ—Å—è—Ç–∫–∏ —Ç—ã—Å—è—á –∑–∞–∫–∞–∑–æ–≤ –≤ —Å—É—Ç–∫–∏.
// –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞ - –∏ 30 - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ–∫–æ–≤ –≤ –Ω–∞–ª–æ–≥–æ–≤—É—é (–≤–æ –≤–Ω–µ—à–Ω–∏–π –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π —Å–µ—Ä–≤–∏—Å)
// (–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ - Kubernetes 8 –ø–æ–¥–æ–≤ (—Ä–µ–ø–ª–∏–∫), –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π).
// –î–≤–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–ø—Ä–æ—Ü–µ—Å—Å–∞)
//                1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–¥ (Postgres) —Å–≤–µ–¥–µ–Ω–∏—è –æ –¥–∞–Ω–Ω—ã—Ö –≤ —á–µ–∫ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –ù–∞–ª–æ–≥–æ–≤—É—é - –º–µ—Ç–æ–¥ sendReceipt (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏).
//                2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (—Ä–∞–∑ –≤ —á–∞—Å) —á–µ–∫–æ–≤ –≤–æ–∑–≤—Ä–∞—Ç–∞ - –º–µ—Ç–æ–¥ processJobRunning.
// TaxClient - –∫–ª–∏–µ–Ω—Ç –Ω–∞–ª–æ–≥–æ–≤–æ–π (feign) - timeout = 60 —Å–µ–∫—É–Ω–¥ (–Ω–µ –Ω–∞—à, –Ω–µ –º–æ–∂–µ–º –ø–æ–≤–ª–∏—è—Ç—å)

@Service
@AllArgsConstructor
public class SomeServiceImpl implements Someservice {
    private final TaxClient taxClient;
    private final ReceiptDao receiptDao;
    private final ReceiptTypeDao receiptTypeDao;

    private final ReceiptMapper mapper;
    private final ReceiptTypeMapper typeMapper;
    private final RefundReceiptMapper refundReceiptMapper;
    private final SomeService self;

    @Scheduled(cron = ""${cron.expression}"") // ""30 30 * * *""
    public void processJobRunning() {
        List<Receipt> receipts = getRefundReceipts();

        for (Receipt receipt : receipts) {
            receipt.setProcessed(true);
            eventListener.sendEventToAnalytics(new SomeEvent(receipt.getId()); //send simple event, using org.springframework.context.event, idempotent
            receiptDao.save(mapReceipt(mapper.map(receipt)));
        }
    }

    @Transactional(readOnly = true)
    public List<Receipt> getRefundReceipts() {
        return receiptDao.findAllBySourceAndProcessedFalse(ReceiptSource.REFUND); // select * from receipt where source = 'REFUNC' and processed = false;
    }

    private Receipt mapReceipt(ReceiptDto receiptDto) {
        return mapper.map(receiptDto);
    }

    //–ø—Ä–∏—Ö–æ–¥–∏—Ç http-–∑–∞–ø—Ä–æ—Å –∏–∑ –¥—Ä—É–≥–æ–≥–æ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞
    public void sendReceipt(ReceiptDto receiptDto) {
        ReceiptSource source = self.getReceiptSource(receiptDto);
        taxClient.sendReceipt(receiptDto, source);
    }

    @Transactional
    @Cacheable(value = ""receipt_type"", cacheManager = ""redisCacheManager"") // –ø–æ —Å—É—Ç–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ hashMap
    public ReceiptSource getReceiptSource(ReceiptDto receiptDto) {
        Receipt receipt = receiptDao.findById(receiptDto.getId());
        ReceiptSource source = receipt.getSource();
        return source;
    }
}


// –≥—Ä–∞–Ω–∏—Ü–∞ –∫–ª–∞—Å—Å–∞ ----
public interface ReceiptDao extends JpaRepository<Receipt, Long> {
    List<Receipt> findAllBySourceAndProcessedFalse(ReceiptSource source);
}

//—Ç—É—Ç –≤—Å–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ - –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ - mapstruct
@Mapper(componentModel = SPRING)
public interface ReceiptMapper {
    Receipt map(ReceiptDto dto);
    ReceiptDto map(Receipt receipt);
}

// –≥—Ä–∞–Ω–∏—Ü–∞ –∫–ª–∞—Å—Å–∞ ----
// —Ç—É—Ç –≤—Å–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ - dto –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
public enum ReceiptSource {
    DISCOUNT,
    SELL,
    REFUND
}

// –≥—Ä–∞–Ω–∏—Ü–∞ –∫–ª–∞—Å—Å–∞ ----
//—Ç—É—Ç –≤—Å–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ - dto –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
@Data
@NoArgsConstructor
public class ReceiptDto {
    private Long id;
    private String address;
    private String sum;
    private ReceiptSource source;
}

// –≥—Ä–∞–Ω–∏—Ü–∞ –∫–ª–∞—Å—Å–∞ ----
//—Ç—É—Ç –≤—Å–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ - entity –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
//@Data
@Entity
@ALLArgsConstructor
@NoArgsConstructor
@Data
public class Receipt {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private boolean processed;
    private String address;
    private String sum;
    private ReceiptSource source;
}
````

{{< hint warning >}}  
**–°–ø–æ–π–ª–µ—Ä—ã –∫ —Ä–µ—à–µ–Ω–∏—é**  
{{< /hint >}}

{{< details "–ü–æ–¥—Å–∫–∞–∑–∫–∏" close >}}  
üí° –í `@Scheduled` –Ω—É–∂–Ω–æ –ø–∏—Å–∞—Ç—å `cron = "${cron.expression}"`, –∞ –Ω–µ –¥–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –≤–Ω—É—Ç—Ä–∏.  
üí° AOP-–ø—Ä–æ–∫—Å–∏ Spring —Å `@Cacheable` –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `this.getReceiptSource(...)` ‚Äî –Ω–∞–¥–æ –≤—ã–∑—ã–≤–∞—Ç—å —á–µ—Ä–µ–∑ –±–∏–Ω–æ–≤—ã–π –ø—Ä–æ–∫—Å–∏ (`self.getReceiptSource(...)`).  
üí° `findById()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `Optional<Receipt>` ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞–ø–∏—Å–∏.  
üí° –ß—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç–æ–∫ –¥–æ–ª–≥–∏–º Feign‚Äë–≤—ã–∑–æ–≤–æ–º, —Å–¥–µ–ª–∞–π—Ç–µ `sendReceipt()` –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º (`@Async`) –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ DTO –≤ –æ—á–µ—Ä–µ–¥—å (Kafka/RabbitMQ).  
üí° –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞ –æ–±–æ—Ä–∞—á–∏–≤–∞–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–±—ã—Ç–∏—è –≤ `try/catch`, —á—Ç–æ–±—ã –æ–¥–Ω–∞ –æ—à–∏–±–∫–∞ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–ª–∞ –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å.  
{{< /details >}}

{{< details "–†–µ—à–µ–Ω–∏–µ" close >}}

```java
import java.util.List;
import java.util.concurrent.Executor;
import lombok.AllArgsConstructor;
import org.springframework.cache.annotation.Cacheable;
import org.springframework.scheduling.annotation.Async;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@AllArgsConstructor
public class SomeServiceImpl implements SomeService {
    private final TaxClient taxClient;
    private final ReceiptDao receiptDao;
    private final SomeEventListener eventListener;
    private final SomeService self;  // –±–∏–Ω–æ–≤—ã–π –ø—Ä–æ–∫—Å–∏ –¥–ª—è AOP

    @Scheduled(cron = "${cron.expression}")
    public void processJobRunning() {
        List<Receipt> receipts = getRefundReceipts();
        for (Receipt receipt : receipts) {
            try {
                receipt.setProcessed(true);
                eventListener.sendEventToAnalytics(new SomeEvent(receipt.getId()));
                receiptDao.save(receipt);
            } catch (Exception ex) {
                // –ª–æ–≥–∏—Ä—É–µ–º –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
                log.error("Error processing receipt {}", receipt.getId(), ex);
            }
        }
    }

    @Transactional(readOnly = true)
    public List<Receipt> getRefundReceipts() {
        return receiptDao.findAllBySourceAndProcessedFalse(ReceiptSource.REFUND);
    }

    public void sendReceipt(ReceiptDto receiptDto) {
        // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ Spring
        self.sendReceiptAsync(receiptDto);
    }

    @Async("taskExecutor")
    public void sendReceiptAsync(ReceiptDto receiptDto) {
        ReceiptSource source = getReceiptSource(receiptDto);
        taxClient.sendReceipt(receiptDto, source);
    }

    @Transactional
    @Cacheable(value = "receipt_type", cacheManager = "redisCacheManager")
    public ReceiptSource getReceiptSource(ReceiptDto receiptDto) {
        Receipt receipt = receiptDao.findById(receiptDto.getId())
            .orElseThrow(() -> new EntityNotFoundException("Receipt not found: " + receiptDto.getId()));
        return receipt.getSource();
    }
}
```

{{< /details >}}